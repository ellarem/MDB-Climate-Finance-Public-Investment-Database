<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MDB Climate Finance Public Investment Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jQuery (required for DataTables jQuery build) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- DataTables CSS + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 1.6rem; }
    .sub { color:#555; margin-bottom: 18px; }
    #status { margin: 10px 0 18px; font-size: .95rem; }
    #status.loading { color:#555; }
    #status.error { color:#b00020; }

    /* Keep widths stable and truncate long text */
    table.dataTable { table-layout: fixed; width: 100% !important; }
    table.dataTable th, table.dataTable td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Sticky header + filter row */
    table.dataTable thead th { position: sticky; top: 0; background: #fff; z-index: 3; }
    table.dataTable thead tr.filters th { position: sticky; top: 38px; background: #fff; z-index: 2; }
    thead input {
      width: 100%; box-sizing: border-box; padding: 4px 6px;
      border: 1px solid #ddd; border-radius: 6px; font-size: 12px;
    }
    .dt-buttons { margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>MDB Climate Finance Public Investment Database</h1>
  <div class="sub">Type in any column’s filter to narrow results. Use the global search too. Export buttons are above the table.</div>
  <div id="status" class="loading">Loading data…</div>

  <table id="mdbTable" class="display" style="width:100%">
    <thead id="tblHead"></thead>
  </table>

  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- DataTables + Buttons (ORDER MATTERS) -->
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // CSV sits next to index.html in the repo root
    const CSV_URL = "mdb_climate_finance.csv?v=" + Date.now();
    const statusEl = document.getElementById('status');
    const showStatus = (msg, type='') => { statusEl.textContent = msg; statusEl.className = type; };

    // Build a two-row THEAD: titles + filter inputs
    function buildThead(headers) {
      const head = document.getElementById('tblHead');
      const titleRow = document.createElement('tr');
      const filterRow = document.createElement('tr');
      filterRow.className = 'filters';

      headers.forEach(h => {
        const thTitle = document.createElement('th');
        thTitle.textContent = h;
        titleRow.appendChild(thTitle);

        const thFilter = document.createElement('th');
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Filter…';
        input.setAttribute('data-col', h);
        thFilter.appendChild(input);
        filterRow.appendChild(thFilter);
      });

      head.innerHTML = '';
      head.appendChild(titleRow);
      head.appendChild(filterRow);
    }

    // Simple debounce so we don't filter on every keystroke
    const debounce = (fn, ms=250) => {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    };

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: "greedy",
      beforeFirstChunk: chunk => chunk.replace(/^\uFEFF?(\s*\r?\n)+/, ""), // strip BOM/blank lines
      complete: ({ data, errors }) => {
        if (errors && errors.length) console.warn("Papa errors:", errors.slice(0,5));
        if (!data || !data.length) { showStatus("CSV loaded but no rows found.", "error"); return; }

        const headers = Object.keys(data[0] || {}).filter(k => k && k !== "undefined");
        const columns = headers.map(k => ({ title: k, data: k }));
        buildThead(headers);

        const table = $('#mdbTable').DataTable({
          data,
          columns,
          pageLength: 25,
          deferRender: true,
          responsive: true,
          orderCellsTop: true,   // make second header row usable for filters
          autoWidth: false,      // stop width jumping
          dom: 'Bfrtip',
          buttons: [
            { extend: 'csvHtml5', title: 'mdb_climate_finance', text: 'Download CSV' },
            { extend: 'excelHtml5', title: 'mdb_climate_finance', text: 'Download Excel' }
          ],
          initComplete: function () {
            const api = this.api();

            // Hook up each filter input to its column
            $(api.table().header()).find('tr.filters th').each(function (i) {
              const input = $('input', this);
              input.on('keyup change', debounce(function () {
                const val = this.value;
                // Use smart search (no regex) to avoid special-char issues
                if (api.column(i).search() !== val) {
                  api.column(i).search(val, false, true).draw();
                }
              }, 250));
            });

            // After first draw, lock widths
            api.columns.adjust();
          }
        });

        showStatus(`Loaded ${data.length} rows.`, "sub");
      },
      error: err => { console.error(err); showStatus("Error loading CSV: " + (err?.message || err), "error"); }
    });
  </script>
</body>
</html>

